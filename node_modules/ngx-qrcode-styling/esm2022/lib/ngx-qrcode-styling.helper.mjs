import QRCodeStyling from 'qr-code-styling';
import { AsyncSubject } from 'rxjs';
import { Templates } from './ngx-qrcode-styling.templates';
/**
 * drawQrcode
 * @param config
 * @param container
 * @returns
 */
export function drawQrcode(config, container) {
    const subject = new AsyncSubject();
    // Reject
    if (!config || !container) {
        subject.error('Container or Config not available!');
        subject.complete();
        return subject;
    }
    ;
    const element = document.createElement("div");
    /**
     * QRCODE_NONE_FRAME
     * @returns
     */
    const QRCODE_NONE_FRAME = () => {
        if (config?.frameOptions) {
            return false;
        }
        else {
            const encodeConfig = () => {
                let deep = config && JSON.parse(JSON.stringify(config)); // deep
                return Object.assign({ data: window.unescape(encodeURIComponent(deep?.data ?? '')) }, deep);
            };
            // removeChild
            while (container.firstChild) {
                container.removeChild(container.lastChild);
            }
            const CR = new QRCodeStyling(encodeConfig());
            // append to container
            CR.append(container);
            return true;
        }
    };
    const styleName = config?.frameOptions?.style ?? 'F_020';
    const height = config?.frameOptions?.height ?? 300;
    const width = config?.frameOptions?.width ?? 300;
    const x = config?.frameOptions?.x ?? 50;
    const y = config?.frameOptions?.y ?? 50;
    /**
     * ADD_FRAME_SVG_TO_ELEMENT
     * @returns
     */
    const ADD_FRAME_SVG_TO_ELEMENT = () => {
        const http = fetch(`https://cdn.jsdelivr.net/gh/id1945/ngx-qrcode-styling/svg/1.2.9/${styleName}.svg`, { method: 'GET' });
        return new Promise((resolve, reject) => {
            http.then(response => response.text()).then(result => {
                if (result !== "404: Not Found") {
                    upgradeSvg(result);
                }
                resolve(result);
            }).catch(error => {
                console.error(error);
                reject(error);
            });
        });
    };
    const upgradeSvg = (result) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(result, "image/svg+xml");
        if (doc) {
            const svgEl = doc.documentElement.children[styleName + '_svg'];
            if (!svgEl)
                return;
            const textEls = svgEl.getElementsByClassName("frame-text");
            const contentEls = svgEl.getElementsByClassName("frame-content");
            const containerEls = svgEl.getElementsByClassName("frame-container");
            config?.frameOptions?.background && svgEl.setAttribute('style', `background: ${config?.frameOptions?.background};${svgEl?.getAttribute('style')}`);
            const updateStyle = (el, config) => {
                if (el) {
                    for (const key in config) {
                        if (['x', 'y', 'transform'].includes(key)) {
                            el.setAttribute(key, config && config[key]);
                        }
                        else if (['textContent'].includes(key)) {
                            el[key] = config && config[key];
                        }
                        else {
                            el.style[key] = config && config[key];
                        }
                    }
                }
            };
            const createElementNS = (config) => {
                const svgNS = "http://www.w3.org/2000/svg";
                const newText = document.createElementNS(svgNS, "text");
                updateStyle(newText, config);
                svgEl.appendChild(newText);
            };
            if (config?.frameOptions?.texts) {
                [...config.frameOptions.texts].forEach((text, i) => {
                    const el = [...textEls]?.[i];
                    el ? updateStyle(el, text) : createElementNS(text);
                });
            }
            if (config?.frameOptions?.containers) {
                [...containerEls].forEach((el, i) => {
                    updateStyle(el, config?.frameOptions?.containers?.[i]);
                });
            }
            if (config?.frameOptions?.contents) {
                [...contentEls].forEach((el, i) => {
                    updateStyle(el, config?.frameOptions?.contents?.[i]);
                });
            }
            element.appendChild(doc.documentElement);
        }
    };
    /**
     * UPDATE_POSITION_QRCODE_ON_FRAME
     * @returns HTMLElement
     */
    const UPDATE_POSITION_QRCODE_ON_FRAME = () => {
        const after = element.querySelector('.ngx_qrcode_styling_after');
        if (after && config?.zIndex === 1) {
            after?.setAttribute("transform", `translate(${x},${y})`);
            return after;
        }
        const before = element.querySelector('.ngx_qrcode_styling_before');
        before?.setAttribute("transform", `translate(${x},${y})`);
        return before;
    };
    /**
     * UPDATE_ROTATE_SCALE_QRCODE_ON_FRAME
     * @param svg
     * @returns void
     */
    const UPDATE_ROTATE_SCALE_QRCODE_ON_FRAME = (svg) => {
        if (svg && config?.rotate) {
            svg?.childNodes?.[0]?.childNodes?.forEach((node) => {
                if (node.nodeName === 'rect') {
                    node.style.transformOrigin = `50% 50%`;
                    node.style.transform = `rotate(${config?.rotate ?? 0}deg)`;
                }
            });
        }
        if (svg && config?.scale) {
            svg?.childNodes?.[0]?.childNodes?.forEach((node) => {
                if (node.nodeName === 'rect') {
                    node.style.scale = config?.scale ?? 0;
                }
            });
        }
    };
    /**
     * CREATE_QRCODE_INTO_FRAME
     * @param addsvg
     * @returns
     */
    const CREATE_QRCODE_INTO_FRAME = (addsvg) => {
        const defaultConfig = () => {
            let deep = config && JSON.parse(JSON.stringify(config)); // deep
            deep = { ...deep, ...{ type: 'svg', data: window.unescape(encodeURIComponent(deep?.data ?? '')) } };
            delete deep.frameOptions;
            delete deep.template;
            return deep;
        };
        // removeChild
        while (container?.firstChild) {
            container.removeChild(container.lastChild);
        }
        const CR = new QRCodeStyling(defaultConfig());
        return CR?._svgDrawingPromise?.then(() => {
            CR.append(addsvg);
        }).catch((error) => console.error(error));
    };
    /**
     * QRCODE_TYPE_SVG
     * @returns
     */
    const QRCODE_TYPE_SVG = () => {
        if (config?.type === 'svg') {
            UPDATE_SIZE_SVG();
            container.appendChild(element);
            return true;
        }
        return false;
    };
    /**
     * CREATE_CANVAS_WITH_SIZE
     * @returns
     */
    const CREATE_CANVAS_WITH_SIZE = () => {
        const canvas = document.createElement('canvas');
        canvas.height = height;
        canvas.width = width;
        container.appendChild(canvas);
        return canvas;
    };
    /**
     * ELEMENT_CONVERT_TO_BASE64
     * @param s1
     * @returns
     */
    const ELEMENT_CONVERT_TO_BASE64 = (s1) => {
        let b64 = "data:image/svg+xml;base64,";
        const xml = s1 && new XMLSerializer().serializeToString(s1);
        return b64 += xml && btoa(unescape(encodeURIComponent(xml)));
    };
    /**
     * UPDATE_SIZE_SVG
     * @returns
     */
    const UPDATE_SIZE_SVG = () => {
        const s1 = element.querySelector(`#${styleName}_svg`);
        s1 && s1.setAttribute('height', `${height}px`);
        s1 && s1.setAttribute('width', `${width}px`);
        return s1;
    };
    /**
     * BASE64_TO_BLOB
     * @param base64Image
     * @returns
     */
    const BASE64_TO_BLOB = (base64Image) => {
        // Split into two parts
        const parts = base64Image.split(";base64,");
        // Hold the content type
        const imageType = parts[0].split(":")[1];
        // Decode Base64 string
        const decodedData = window.atob(parts[1]);
        // Create UNIT8ARRAY of size same as row data length
        const uInt8Array = new Uint8Array(decodedData.length);
        // Insert all character code into uInt8Array
        for (let i = 0; i < decodedData.length; ++i) {
            uInt8Array[i] = decodedData.charCodeAt(i);
        }
        // Return BLOB image after conversion
        return new Blob([uInt8Array], { type: imageType });
    };
    /**
     * CREATE_IMAGE
     */
    const CREATE_IMAGE = () => {
        const img = new Image();
        const ctx = CREATE_CANVAS_WITH_SIZE().getContext("2d");
        img.onload = function () {
            ctx && ctx.drawImage(img, 0, 0);
        };
        const blob = BASE64_TO_BLOB(ELEMENT_CONVERT_TO_BASE64(UPDATE_SIZE_SVG()));
        const blobUrl = URL.createObjectURL(blob);
        img.src = blobUrl;
    };
    /**
     * MAIN
     */
    (async function () {
        if (QRCODE_NONE_FRAME()) {
            subject.next({ config, container });
            subject.complete();
            return; // Mode qrcode basic
        }
        else {
            await ADD_FRAME_SVG_TO_ELEMENT();
            const ADDSVG = UPDATE_POSITION_QRCODE_ON_FRAME();
            await CREATE_QRCODE_INTO_FRAME(ADDSVG);
            UPDATE_ROTATE_SCALE_QRCODE_ON_FRAME(ADDSVG);
            if (QRCODE_TYPE_SVG()) {
                // Mode qrcode + frame type svg
                subject.next({ config, container });
                subject.complete();
            }
            else {
                // Mode qrcode + frame type canvas
                CREATE_IMAGE();
                subject.next({ config, container });
                subject.complete();
            }
        }
    })();
    return subject;
}
/**
 * defaultTemplate
 * @param config
 * @returns
 */
export const defaultTemplate = (config) => {
    let deep = config && JSON.parse(JSON.stringify(config));
    return config?.template ? { ...Templates(config.template.toLocaleLowerCase()), ...deep } : deep;
};
/**
 * deepUpdate
 * @param config
 * @param configUpdate
 * @returns
 */
export const deepUpdate = async (config, configUpdate) => {
    const origin = config && JSON.parse(JSON.stringify(config));
    let clone = { ...origin, ...configUpdate };
    const keys = ['frameOptions', 'qrOptions', 'imageOptions', 'dotsOptions', 'cornersSquareOptions', 'cornersDotOptions', 'backgroundOptions'];
    for await (const key of keys) {
        if (key in configUpdate) {
            const update = {
                [key]: { ...origin[key], ...configUpdate[key] }
            };
            clone = { ...clone, ...update };
        }
    }
    return clone;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXFyY29kZS1zdHlsaW5nLmhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1xcmNvZGUtc3R5bGluZy9zcmMvbGliL25neC1xcmNvZGUtc3R5bGluZy5oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxhQUFhLE1BQU0saUJBQWlCLENBQUM7QUFDNUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUdwQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFM0Q7Ozs7O0dBS0c7QUFDSCxNQUFNLFVBQVUsVUFBVSxDQUFDLE1BQWUsRUFBRSxTQUFnRjtJQUV4SCxNQUFNLE9BQU8sR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0lBRW5DLFNBQVM7SUFDVCxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsU0FBUyxFQUFFO1FBQ3ZCLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztRQUNwRCxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDbkIsT0FBTyxPQUFPLENBQUM7S0FDbEI7SUFBQSxDQUFDO0lBRUYsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUU5Qzs7O09BR0c7SUFDSCxNQUFNLGlCQUFpQixHQUFHLEdBQUcsRUFBRTtRQUMzQixJQUFJLE1BQU0sRUFBRSxZQUFZLEVBQUU7WUFDdEIsT0FBTyxLQUFLLENBQUM7U0FDaEI7YUFBTTtZQUNILE1BQU0sWUFBWSxHQUFHLEdBQUcsRUFBRTtnQkFDdEIsSUFBSSxJQUFJLEdBQUcsTUFBTSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTztnQkFDaEUsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFHLE1B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O0FBQ2pCLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBRUkNvZGVTdHlsaW5nIGZyb20gJ3FyLWNvZGUtc3R5bGluZyc7XHJcbmltcG9ydCB7IEFzeW5jU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgT3B0aW9ucyB9IGZyb20gJy4vbmd4LXFyY29kZS1zdHlsaW5nLm9wdGlvbnMnO1xyXG5pbXBvcnQgeyBUZW1wbGF0ZXMgfSBmcm9tICcuL25neC1xcmNvZGUtc3R5bGluZy50ZW1wbGF0ZXMnO1xyXG5cclxuLyoqXHJcbiAqIGRyYXdRcmNvZGVcclxuICogQHBhcmFtIGNvbmZpZyBcclxuICogQHBhcmFtIGNvbnRhaW5lciBcclxuICogQHJldHVybnMgXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZHJhd1FyY29kZShjb25maWc6IE9wdGlvbnMsIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQgfCBIVE1MVmlkZW9FbGVtZW50IHwgSFRNTENhbnZhc0VsZW1lbnQgfCBTVkdFbGVtZW50IHwgYW55KTogQXN5bmNTdWJqZWN0PGFueT4ge1xyXG5cclxuICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgQXN5bmNTdWJqZWN0KCk7XHJcblxyXG4gICAgLy8gUmVqZWN0XHJcbiAgICBpZiAoIWNvbmZpZyB8fCAhY29udGFpbmVyKSB7XHJcbiAgICAgICAgc3ViamVjdC5lcnJvcignQ29udGFpbmVyIG9yIENvbmZpZyBub3QgYXZhaWxhYmxlIScpO1xyXG4gICAgICAgIHN1YmplY3QuY29tcGxldGUoKTtcclxuICAgICAgICByZXR1cm4gc3ViamVjdDtcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBRUkNPREVfTk9ORV9GUkFNRVxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIGNvbnN0IFFSQ09ERV9OT05FX0ZSQU1FID0gKCkgPT4ge1xyXG4gICAgICAgIGlmIChjb25maWc/LmZyYW1lT3B0aW9ucykge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgZW5jb2RlQ29uZmlnID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IGRlZXAgPSBjb25maWcgJiYgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShjb25maWcpKTsgLy8gZGVlcFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyBkYXRhOiAod2luZG93IGFzIGFueSkudW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGRlZXA/LmRhdGEgPz8gJycpKSB9LCBkZWVwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyByZW1vdmVDaGlsZFxyXG4gICAgICAgICAgICB3aGlsZSAoY29udGFpbmVyLmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChjb250YWluZXIubGFzdENoaWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBDUiA9IG5ldyBRUkNvZGVTdHlsaW5nKGVuY29kZUNvbmZpZygpIGFzIE9wdGlvbnMpO1xyXG4gICAgICAgICAgICAvLyBhcHBlbmQgdG8gY29udGFpbmVyXHJcbiAgICAgICAgICAgIENSLmFwcGVuZChjb250YWluZXIpO1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3R5bGVOYW1lID0gY29uZmlnPy5mcmFtZU9wdGlvbnM/LnN0eWxlID8/ICdGXzAyMCc7XHJcbiAgICBjb25zdCBoZWlnaHQgPSBjb25maWc/LmZyYW1lT3B0aW9ucz8uaGVpZ2h0ID8/IDMwMDtcclxuICAgIGNvbnN0IHdpZHRoID0gY29uZmlnPy5mcmFtZU9wdGlvbnM/LndpZHRoID8/IDMwMDtcclxuICAgIGNvbnN0IHggPSBjb25maWc/LmZyYW1lT3B0aW9ucz8ueCA/PyA1MDtcclxuICAgIGNvbnN0IHkgPSBjb25maWc/LmZyYW1lT3B0aW9ucz8ueSA/PyA1MDtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEFERF9GUkFNRV9TVkdfVE9fRUxFTUVOVFxyXG4gICAgICogQHJldHVybnNcclxuICAgICAqL1xyXG4gICAgY29uc3QgQUREX0ZSQU1FX1NWR19UT19FTEVNRU5UID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGh0dHAgPSBmZXRjaChgaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL2lkMTk0NS9uZ3gtcXJjb2RlLXN0eWxpbmcvc3ZnLzEuMi45LyR7c3R5bGVOYW1lfS5zdmdgLCB7IG1ldGhvZDogJ0dFVCcgfSlcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBodHRwLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UudGV4dCgpKS50aGVuKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICE9PSBcIjQwNDogTm90IEZvdW5kXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICB1cGdyYWRlU3ZnKHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdXBncmFkZVN2ZyA9IChyZXN1bHQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTtcclxuICAgICAgICBjb25zdCBkb2MgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKHJlc3VsdCwgXCJpbWFnZS9zdmcreG1sXCIpO1xyXG4gICAgICAgIGlmIChkb2MpIHtcclxuICAgICAgICAgICAgY29uc3Qgc3ZnRWwgPSAoZG9jLmRvY3VtZW50RWxlbWVudC5jaGlsZHJlbiBhcyBhbnkpW3N0eWxlTmFtZSArICdfc3ZnJ107XHJcbiAgICAgICAgICAgIGlmICghc3ZnRWwpIHJldHVybjtcclxuICAgICAgICAgICAgY29uc3QgdGV4dEVscyA9IHN2Z0VsLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJmcmFtZS10ZXh0XCIpO1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50RWxzID0gc3ZnRWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcImZyYW1lLWNvbnRlbnRcIik7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lckVscyA9IHN2Z0VsLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJmcmFtZS1jb250YWluZXJcIik7XHJcbiAgICAgICAgICAgIGNvbmZpZz8uZnJhbWVPcHRpb25zPy5iYWNrZ3JvdW5kICYmIHN2Z0VsLnNldEF0dHJpYnV0ZSgnc3R5bGUnLGBiYWNrZ3JvdW5kOiAke2NvbmZpZz8uZnJhbWVPcHRpb25zPy5iYWNrZ3JvdW5kfTske3N2Z0VsPy5nZXRBdHRyaWJ1dGUoJ3N0eWxlJyl9YCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVN0eWxlID0gKGVsOiBhbnksIGNvbmZpZzogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBjb25maWcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChbJ3gnLCAneScsICd0cmFuc2Zvcm0nXSBhcyBhbnkpLmluY2x1ZGVzKGtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIGNvbmZpZyAmJiBjb25maWdba2V5XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKFsndGV4dENvbnRlbnQnXSBhcyBhbnkpLmluY2x1ZGVzKGtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsW2tleV0gPSBjb25maWcgJiYgY29uZmlnW2tleV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5zdHlsZVtrZXldID0gY29uZmlnICYmIGNvbmZpZ1trZXldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjcmVhdGVFbGVtZW50TlMgPSAoY29uZmlnOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN2Z05TID0gXCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3VGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhzdmdOUywgXCJ0ZXh0XCIpO1xyXG4gICAgICAgICAgICAgICAgdXBkYXRlU3R5bGUobmV3VGV4dCwgY29uZmlnKTtcclxuICAgICAgICAgICAgICAgIHN2Z0VsLmFwcGVuZENoaWxkKG5ld1RleHQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoY29uZmlnPy5mcmFtZU9wdGlvbnM/LnRleHRzKSB7XHJcbiAgICAgICAgICAgICAgICBbLi4uY29uZmlnLmZyYW1lT3B0aW9ucy50ZXh0c10uZm9yRWFjaCgodGV4dDogYW55LCBpOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IFsuLi50ZXh0RWxzXT8uW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgIGVsID8gdXBkYXRlU3R5bGUoZWwsIHRleHQpIDogY3JlYXRlRWxlbWVudE5TKHRleHQpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChjb25maWc/LmZyYW1lT3B0aW9ucz8uY29udGFpbmVycykge1xyXG4gICAgICAgICAgICAgICAgWy4uLmNvbnRhaW5lckVsc10uZm9yRWFjaCgoZWw6IGFueSwgaTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlU3R5bGUoZWwsIGNvbmZpZz8uZnJhbWVPcHRpb25zPy5jb250YWluZXJzPy5baV0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChjb25maWc/LmZyYW1lT3B0aW9ucz8uY29udGVudHMpIHtcclxuICAgICAgICAgICAgICAgIFsuLi5jb250ZW50RWxzXS5mb3JFYWNoKChlbDogYW55LCBpOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVTdHlsZShlbCwgY29uZmlnPy5mcmFtZU9wdGlvbnM/LmNvbnRlbnRzPy5baV0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jLmRvY3VtZW50RWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVVBEQVRFX1BPU0lUSU9OX1FSQ09ERV9PTl9GUkFNRVxyXG4gICAgICogQHJldHVybnMgSFRNTEVsZW1lbnRcclxuICAgICAqL1xyXG4gICAgY29uc3QgVVBEQVRFX1BPU0lUSU9OX1FSQ09ERV9PTl9GUkFNRSA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBhZnRlciA9IGVsZW1lbnQucXVlcnlTZWxlY3RvcignLm5neF9xcmNvZGVfc3R5bGluZ19hZnRlcicpO1xyXG4gICAgICAgIGlmIChhZnRlciAmJiBjb25maWc/LnpJbmRleCA9PT0gMSkge1xyXG4gICAgICAgICAgICBhZnRlcj8uc2V0QXR0cmlidXRlKFwidHJhbnNmb3JtXCIsIGB0cmFuc2xhdGUoJHt4fSwke3l9KWApO1xyXG4gICAgICAgICAgICByZXR1cm4gYWZ0ZXIgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGJlZm9yZSA9IGVsZW1lbnQucXVlcnlTZWxlY3RvcignLm5neF9xcmNvZGVfc3R5bGluZ19iZWZvcmUnKTtcclxuICAgICAgICBiZWZvcmU/LnNldEF0dHJpYnV0ZShcInRyYW5zZm9ybVwiLCBgdHJhbnNsYXRlKCR7eH0sJHt5fSlgKTtcclxuICAgICAgICByZXR1cm4gYmVmb3JlIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVVBEQVRFX1JPVEFURV9TQ0FMRV9RUkNPREVfT05fRlJBTUVcclxuICAgICAqIEBwYXJhbSBzdmdcclxuICAgICAqIEByZXR1cm5zIHZvaWRcclxuICAgICAqL1xyXG4gICAgY29uc3QgVVBEQVRFX1JPVEFURV9TQ0FMRV9RUkNPREVfT05fRlJBTUUgPSAoc3ZnOiBIVE1MRWxlbWVudCkgPT4ge1xyXG4gICAgICAgIGlmIChzdmcgJiYgY29uZmlnPy5yb3RhdGUpIHtcclxuICAgICAgICAgICAgc3ZnPy5jaGlsZE5vZGVzPy5bMF0/LmNoaWxkTm9kZXM/LmZvckVhY2goKG5vZGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZU5hbWUgPT09ICdyZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUudHJhbnNmb3JtT3JpZ2luID0gYDUwJSA1MCVgO1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUudHJhbnNmb3JtID0gYHJvdGF0ZSgke2NvbmZpZz8ucm90YXRlID8/IDB9ZGVnKWA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc3ZnICYmIGNvbmZpZz8uc2NhbGUpIHtcclxuICAgICAgICAgICAgc3ZnPy5jaGlsZE5vZGVzPy5bMF0/LmNoaWxkTm9kZXM/LmZvckVhY2goKG5vZGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZU5hbWUgPT09ICdyZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUuc2NhbGUgPSBjb25maWc/LnNjYWxlID8/IDA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENSRUFURV9RUkNPREVfSU5UT19GUkFNRVxyXG4gICAgICogQHBhcmFtIGFkZHN2ZyBcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBjb25zdCBDUkVBVEVfUVJDT0RFX0lOVE9fRlJBTUUgPSAoYWRkc3ZnOiBIVE1MRWxlbWVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRlZmF1bHRDb25maWcgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBkZWVwID0gY29uZmlnICYmIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY29uZmlnKSk7IC8vIGRlZXBcclxuICAgICAgICAgICAgZGVlcCA9IHsgLi4uZGVlcCwgLi4ueyB0eXBlOiAnc3ZnJywgZGF0YTogKHdpbmRvdyBhcyBhbnkpLnVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChkZWVwPy5kYXRhID8/ICcnKSkgfSB9O1xyXG4gICAgICAgICAgICBkZWxldGUgZGVlcC5mcmFtZU9wdGlvbnM7XHJcbiAgICAgICAgICAgIGRlbGV0ZSBkZWVwLnRlbXBsYXRlO1xyXG4gICAgICAgICAgICByZXR1cm4gZGVlcDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gcmVtb3ZlQ2hpbGRcclxuICAgICAgICB3aGlsZSAoY29udGFpbmVyPy5maXJzdENoaWxkKSB7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChjb250YWluZXIubGFzdENoaWxkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgQ1IgPSBuZXcgUVJDb2RlU3R5bGluZyhkZWZhdWx0Q29uZmlnKCkgYXMgT3B0aW9ucyk7XHJcbiAgICAgICAgcmV0dXJuIENSPy5fc3ZnRHJhd2luZ1Byb21pc2U/LnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICBDUi5hcHBlbmQoYWRkc3ZnKTtcclxuICAgICAgICB9KS5jYXRjaCgoZXJyb3I6IGFueSkgPT4gY29uc29sZS5lcnJvcihlcnJvcikpXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBRUkNPREVfVFlQRV9TVkdcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBjb25zdCBRUkNPREVfVFlQRV9TVkcgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKGNvbmZpZz8udHlwZSA9PT0gJ3N2ZycpIHtcclxuICAgICAgICAgICAgVVBEQVRFX1NJWkVfU1ZHKCk7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChlbGVtZW50KTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENSRUFURV9DQU5WQVNfV0lUSF9TSVpFXHJcbiAgICAgKiBAcmV0dXJucyBcclxuICAgICAqL1xyXG4gICAgY29uc3QgQ1JFQVRFX0NBTlZBU19XSVRIX1NJWkUgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XHJcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IGhlaWdodDtcclxuICAgICAgICBjYW52YXMud2lkdGggPSB3aWR0aDtcclxuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoY2FudmFzKTtcclxuICAgICAgICByZXR1cm4gY2FudmFzO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRUxFTUVOVF9DT05WRVJUX1RPX0JBU0U2NFxyXG4gICAgICogQHBhcmFtIHMxIFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIGNvbnN0IEVMRU1FTlRfQ09OVkVSVF9UT19CQVNFNjQgPSAoczE6IEhUTUxFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgbGV0IGI2NCA9IFwiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxcIjtcclxuICAgICAgICBjb25zdCB4bWwgPSBzMSAmJiBuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKHMxKTtcclxuICAgICAgICByZXR1cm4gYjY0ICs9IHhtbCAmJiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudCh4bWwpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVUERBVEVfU0laRV9TVkdcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBjb25zdCBVUERBVEVfU0laRV9TVkcgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgczEgPSBlbGVtZW50LnF1ZXJ5U2VsZWN0b3IoYCMke3N0eWxlTmFtZX1fc3ZnYCk7XHJcbiAgICAgICAgczEgJiYgczEuc2V0QXR0cmlidXRlKCdoZWlnaHQnLCBgJHtoZWlnaHR9cHhgKTtcclxuICAgICAgICBzMSAmJiBzMS5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgYCR7d2lkdGh9cHhgKTtcclxuICAgICAgICByZXR1cm4gczEgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBCQVNFNjRfVE9fQkxPQlxyXG4gICAgICogQHBhcmFtIGJhc2U2NEltYWdlIFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIGNvbnN0IEJBU0U2NF9UT19CTE9CID0gKGJhc2U2NEltYWdlOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAvLyBTcGxpdCBpbnRvIHR3byBwYXJ0c1xyXG4gICAgICAgIGNvbnN0IHBhcnRzID0gYmFzZTY0SW1hZ2Uuc3BsaXQoXCI7YmFzZTY0LFwiKTtcclxuICAgICAgICAvLyBIb2xkIHRoZSBjb250ZW50IHR5cGVcclxuICAgICAgICBjb25zdCBpbWFnZVR5cGUgPSBwYXJ0c1swXS5zcGxpdChcIjpcIilbMV07XHJcbiAgICAgICAgLy8gRGVjb2RlIEJhc2U2NCBzdHJpbmdcclxuICAgICAgICBjb25zdCBkZWNvZGVkRGF0YSA9IHdpbmRvdy5hdG9iKHBhcnRzWzFdKTtcclxuICAgICAgICAvLyBDcmVhdGUgVU5JVDhBUlJBWSBvZiBzaXplIHNhbWUgYXMgcm93IGRhdGEgbGVuZ3RoXHJcbiAgICAgICAgY29uc3QgdUludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KGRlY29kZWREYXRhLmxlbmd0aCk7XHJcbiAgICAgICAgLy8gSW5zZXJ0IGFsbCBjaGFyYWN0ZXIgY29kZSBpbnRvIHVJbnQ4QXJyYXlcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlY29kZWREYXRhLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIHVJbnQ4QXJyYXlbaV0gPSBkZWNvZGVkRGF0YS5jaGFyQ29kZUF0KGkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBSZXR1cm4gQkxPQiBpbWFnZSBhZnRlciBjb252ZXJzaW9uXHJcbiAgICAgICAgcmV0dXJuIG5ldyBCbG9iKFt1SW50OEFycmF5XSwgeyB0eXBlOiBpbWFnZVR5cGUgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDUkVBVEVfSU1BR0VcclxuICAgICAqL1xyXG4gICAgY29uc3QgQ1JFQVRFX0lNQUdFID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xyXG4gICAgICAgIGNvbnN0IGN0eCA9IENSRUFURV9DQU5WQVNfV0lUSF9TSVpFKCkuZ2V0Q29udGV4dChcIjJkXCIpO1xyXG4gICAgICAgIGltZy5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGN0eCAmJiBjdHguZHJhd0ltYWdlKGltZywgMCwgMCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBibG9iID0gQkFTRTY0X1RPX0JMT0IoRUxFTUVOVF9DT05WRVJUX1RPX0JBU0U2NChVUERBVEVfU0laRV9TVkcoKSkpO1xyXG4gICAgICAgIGNvbnN0IGJsb2JVcmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xyXG4gICAgICAgIGltZy5zcmMgPSBibG9iVXJsO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTUFJTlxyXG4gICAgICovXHJcbiAgICAoYXN5bmMgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChRUkNPREVfTk9ORV9GUkFNRSgpKSB7XHJcbiAgICAgICAgICAgIHN1YmplY3QubmV4dCh7IGNvbmZpZywgY29udGFpbmVyIH0pO1xyXG4gICAgICAgICAgICBzdWJqZWN0LmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgIHJldHVybiAvLyBNb2RlIHFyY29kZSBiYXNpY1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGF3YWl0IEFERF9GUkFNRV9TVkdfVE9fRUxFTUVOVCgpO1xyXG4gICAgICAgICAgICBjb25zdCBBRERTVkcgPSBVUERBVEVfUE9TSVRJT05fUVJDT0RFX09OX0ZSQU1FKCk7XHJcbiAgICAgICAgICAgIGF3YWl0IENSRUFURV9RUkNPREVfSU5UT19GUkFNRShBRERTVkcpO1xyXG4gICAgICAgICAgICBVUERBVEVfUk9UQVRFX1NDQUxFX1FSQ09ERV9PTl9GUkFNRShBRERTVkcpO1xyXG4gICAgICAgICAgICBpZiAoUVJDT0RFX1RZUEVfU1ZHKCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIE1vZGUgcXJjb2RlICsgZnJhbWUgdHlwZSBzdmdcclxuICAgICAgICAgICAgICAgIHN1YmplY3QubmV4dCh7IGNvbmZpZywgY29udGFpbmVyIH0pO1xyXG4gICAgICAgICAgICAgICAgc3ViamVjdC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gTW9kZSBxcmNvZGUgKyBmcmFtZSB0eXBlIGNhbnZhc1xyXG4gICAgICAgICAgICAgICAgQ1JFQVRFX0lNQUdFKCk7XHJcbiAgICAgICAgICAgICAgICBzdWJqZWN0Lm5leHQoeyBjb25maWcsIGNvbnRhaW5lciB9KTtcclxuICAgICAgICAgICAgICAgIHN1YmplY3QuY29tcGxldGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pKCk7XHJcblxyXG4gICAgcmV0dXJuIHN1YmplY3Q7XHJcbn1cclxuXHJcblxyXG4vKipcclxuICogZGVmYXVsdFRlbXBsYXRlXHJcbiAqIEBwYXJhbSBjb25maWcgXHJcbiAqIEByZXR1cm5zIFxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IGRlZmF1bHRUZW1wbGF0ZSA9IChjb25maWc/OiBPcHRpb25zKTogT3B0aW9ucyA9PiB7XHJcbiAgICBsZXQgZGVlcCA9IGNvbmZpZyAmJiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGNvbmZpZykpO1xyXG4gICAgcmV0dXJuIGNvbmZpZz8udGVtcGxhdGUgPyB7IC4uLlRlbXBsYXRlcyhjb25maWcudGVtcGxhdGUudG9Mb2NhbGVMb3dlckNhc2UoKSksIC4uLmRlZXAgfSA6IGRlZXA7XHJcbn07XHJcblxyXG4vKipcclxuICogZGVlcFVwZGF0ZVxyXG4gKiBAcGFyYW0gY29uZmlnIFxyXG4gKiBAcGFyYW0gY29uZmlnVXBkYXRlIFxyXG4gKiBAcmV0dXJucyBcclxuICovXHJcbmV4cG9ydCBjb25zdCBkZWVwVXBkYXRlID0gYXN5bmMgKGNvbmZpZzogT3B0aW9ucywgY29uZmlnVXBkYXRlOiBPcHRpb25zKTogUHJvbWlzZTxPcHRpb25zPiA9PiB7XHJcbiAgICBjb25zdCBvcmlnaW4gPSBjb25maWcgJiYgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShjb25maWcpKTtcclxuICAgIGxldCBjbG9uZSA9IHsgLi4ub3JpZ2luLCAuLi5jb25maWdVcGRhdGUgfTtcclxuICAgIGNvbnN0IGtleXMgPSBbJ2ZyYW1lT3B0aW9ucycsICdxck9wdGlvbnMnLCAnaW1hZ2VPcHRpb25zJywgJ2RvdHNPcHRpb25zJywgJ2Nvcm5lcnNTcXVhcmVPcHRpb25zJywgJ2Nvcm5lcnNEb3RPcHRpb25zJywgJ2JhY2tncm91bmRPcHRpb25zJ107XHJcbiAgICBmb3IgYXdhaXQgKGNvbnN0IGtleSBvZiBrZXlzKSB7XHJcbiAgICAgICAgaWYgKGtleSBpbiBjb25maWdVcGRhdGUpIHtcclxuICAgICAgICAgICAgY29uc3QgdXBkYXRlID0ge1xyXG4gICAgICAgICAgICAgICAgW2tleV06IHsgLi4ub3JpZ2luW2tleV0sIC4uLihjb25maWdVcGRhdGUgYXMgYW55KVtrZXldIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2xvbmUgPSB7IC4uLmNsb25lLCAuLi51cGRhdGUgfTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY2xvbmU7XHJcbn07XHJcbiJdfQ==